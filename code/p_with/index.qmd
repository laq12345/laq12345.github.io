---
title: "With"
lang: zh
description: "with用于简化资源的管理和异常处理"
date: "2025-09-23"
categories: [Python]
image: "../image/py.jpg"
code-overflow: scroll
---

在Python中，`with` 语句是一个非常重要的语法特性，它用于**简化资源的管理和异常处理**。其核心目的是确保资源（如文件、网络连接、数据库连接、锁等）在使用完毕后能够被正确地清理和释放，即使在使用过程中发生错误也不例外。

`with` 语句依赖于 **上下文管理器（Context Manager）** 协议。一个对象要成为上下文管理器，必须实现 `__enter__()` 和 `__exit__()` 这两个特殊方法。

------------------------------------------------------------------------

### 一、`with` 的基本语法

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-0" index="0" total="9">with 表达式 as 变量:
    代码块</code></pre>
```

-   `表达式`：通常是一个返回上下文管理器对象的表达式。
-   `as 变量`：可选，用于接收 `__enter__()` 方法的返回值。
-   `代码块`：在 `with` 块中执行的操作。

------------------------------------------------------------------------

### 二、`with` 的执行流程

当执行 `with` 语句时，Python 会自动调用以下方法：

1.  **调用 `__enter__()` 方法**：

    -   获取资源（如打开文件）。
    -   返回值赋给 `as` 后的变量（如果有的话）。

2.  **执行 `with` 块中的代码**。

3.  **无论代码是否发生异常，都会调用 `__exit__()` 方法**：

    -   释放资源（如关闭文件）。
    -   可以处理异常（返回 `True` 表示异常已被处理，不向外传播）。

------------------------------------------------------------------------

### 三、常见应用场景

#### 1. 文件操作（最常见）

在没有 `with` 时，需要手动关闭文件：

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-1" index="1" total="9">f = open('test.txt', 'r')
try:
    content = f.read()
    print(content)
finally:
    f.close()  # 必须手动关闭</code></pre>
```

使用 `with` 后，文件会自动关闭：

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-2" index="2" total="9">with open('test.txt', 'r') as f:
    content = f.read()
    print(content)
# 文件在此处自动关闭，即使发生异常也会关闭</code></pre>
```

#### 2. 线程锁

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-3" index="3" total="9">import threading

lock = threading.Lock()

with lock:
    # 自动获取锁
    print("临界区操作")
    # 自动释放锁</code></pre>
```

等价于：

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-4" index="4" total="9">lock.acquire()
try:
    print("临界区操作")
finally:
    lock.release()</code></pre>
```

#### 3. 数据库连接

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-5" index="5" total="9">import sqlite3

with sqlite3.connect('example.db') as conn:
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
    print(cursor.fetchall())
# 连接自动提交（如果操作成功）或回滚（如果异常），并关闭</code></pre>
```

------------------------------------------------------------------------

### 四、自定义上下文管理器

你可以通过定义类来创建自己的上下文管理器。

#### 方法一：实现 `__enter__` 和 `__exit__`

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-6" index="6" total="9">class MyContext:
    def __enter__(self):
        print("进入上下文")
        return "资源句柄"

    def __exit__(self, exc_type, exc_value, traceback):
        print("退出上下文，清理资源")
        if exc_type is not None:
            print(f"捕获到异常: {exc_value}")
        return False  # 不抑制异常

# 使用
with MyContext() as resource:
    print(resource)
    # raise ValueError("测试异常")</code></pre>
```

#### 方法二：使用 `contextlib.contextmanager` 装饰器

通过生成器函数定义上下文管理器，更简洁。

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-7" index="7" total="9">from contextlib import contextmanager

@contextmanager
def my_context():
    print("进入上下文")
    try:
        yield "资源句柄"
    except Exception as e:
        print(f"处理异常: {e}")
        # 可选择是否重新抛出
    finally:
        print("退出上下文，清理资源")

# 使用
with my_context() as resource:
    print(resource)</code></pre>
```

------------------------------------------------------------------------

### 五、`with` 的优势

1.  **自动资源管理**：无需手动调用 `close()` 或 `release()`。
2.  **异常安全**：即使发生异常，`__exit__` 也会执行，确保资源释放。
3.  **代码简洁**：减少 `try...finally` 的模板代码。
4.  **可读性强**：清晰地表达“获取-使用-释放”的资源生命周期。

------------------------------------------------------------------------

### 六、注意事项

-   `with` 块结束后，资源通常会被释放，变量仍然存在但可能已无效（如文件对象已关闭）。
-   多个上下文管理器可以一起使用：

```{=html}
<pre style="background: none"><code class="language-python" data-language="python" identifier="7788f2b2ba2b45849de55f889805be1f-8" index="8" total="9">with open('in.txt') as f1, open('out.txt', 'w') as f2:
    f2.write(f1.read())</code></pre>
```

------------------------------------------------------------------------

### 总结

`with` 语句是 Python 中实现**确定性资源管理**（Deterministic Resource Management）的最佳实践。它通过上下文管理器协议，让资源的获取和释放变得安全、简洁、优雅。无论是文件操作、锁、数据库连接，还是自定义资源，都应该优先使用 `with` 语句来管理。